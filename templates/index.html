<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StyleVision</title>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ================================
           RESET + BASE
        =================================*/
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Barlow", sans-serif;
        background: radial-gradient(circle at center, #171717, #0d0d0d);
        min-height: 100vh;
        padding: 30px;
        color: #f5f5f5;
      }

      .container {
        max-width: 1380px;
        margin: 0 auto;
      }

      /* ================================
           HEADER
        =================================*/
      header {
        text-align: center;
        margin-bottom: 38px;
      }

      h1 {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(90deg, #ffffff, #dcdcdc, #ffffff);
        -webkit-background-clip: text;
        color: transparent;
        letter-spacing: 0.06em;
      }

      .subtitle {
        opacity: 0.75;
        margin-top: 4px;
        font-size: 1.1rem;
      }

      /* ================================
           GRID
        =================================*/
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 32px;
      }

      /* ================================
           CARD
        =================================*/
      .card {
        background: #141414;
        border-radius: 20px;
        padding: 28px;
        border: 1px solid #262626;
        box-shadow: 0 6px 28px rgba(0, 0, 0, 0.4);
      }

      .card h2 {
        font-size: 1.2rem;
        letter-spacing: 0.15em;
        color: #e7e7e7;
        margin-bottom: 18px;
      }

      /* ================================
           VIDEO AREA
        =================================*/
      .video-container {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        aspect-ratio: 16/9;
        background: #000;
        border: 1px solid #333;
        transition: box-shadow 0.35s ease;
      }

      .video-container.active {
        box-shadow: 0 0 16px #45d16d75;
      }

      #videoFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Placeholder elegante */
      #videoFeed[alt="C√¢mera desativada"] {
        background: repeating-linear-gradient(
          135deg,
          #0d0d0d,
          #0d0d0d 10px,
          #161616 10px,
          #161616 20px
        );
      }

      /* STATUS BADGE */
      .status-badge {
        position: absolute;
        top: 14px;
        left: 14px;
        padding: 7px 16px;
        border-radius: 30px;
        font-size: 0.88rem;
        font-weight: 600;
        backdrop-filter: blur(4px);
      }

      .status-inactive {
        background: rgba(255, 80, 80, 0.85);
      }

      .status-active {
        background: rgba(65, 200, 110, 0.85);
      }

      .status-countdown {
        background: #ffd166;
        color: #000;
        animation: pulse 1s infinite;
        font-size: 1rem;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.55;
        }
      }

      /* PREVIEW CAPTURADA */
      .captured-preview {
        margin-top: 20px;
        display: none;
      }

      .captured-preview img {
        width: 100%;
        border-radius: 14px;
        border: 2px solid #ffd166;
      }

      /* ================================
           BUTTONS (HIERARQUIA PEDIDA)
        =================================*/
      .controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .btn {
        padding: 16px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
        color: #fff;
      }

      /* --- 1. DESTAQUES (COLORIDOS) --- */

      /* Ativar Sistema -> Dourado */
      .btn-primary {
        background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
        color: #111;
        border: none;
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
      }

      /* Desativar Sistema -> Vermelho */
      .btn-danger {
        background: linear-gradient(135deg, #c62828 0%, #8e0000 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 15px rgba(198, 40, 40, 0.4);
      }

      /* --- 2. RESTO (NEUTROS/CINZA) --- */
      /* Usando IDs e !important para garantir a cor cinza */
      #btnGravar, 
      #btnParar, 
      #btnCapturar, 
      #btnUpload, 
      #btnDescrever {
        background: #222 !important;
        border: 1px solid #333 !important;
        color: #aaa !important; /* Texto mais apagado */
        box-shadow: none !important;
      }

      /* Hover dos neutros (fica mais claro ao passar o mouse) */
      #btnGravar:hover:not(:disabled), 
      #btnParar:hover:not(:disabled), 
      #btnCapturar:hover:not(:disabled), 
      #btnUpload:hover:not(:disabled), 
      #btnDescrever:hover:not(:disabled) {
        background: #333 !important;
        border-color: #555 !important;
        color: #fff !important;
      }

      .btn-full-width {
        grid-column: 1 / -1;
      }

      /* Bot√µes desabilitados */
      .btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background: #1a1a1a !important;
        border-color: transparent !important;
        color: #444 !important;
        box-shadow: none !important;
        transform: none !important;
      }

    

      /* ================================
           RECORDING INDICATOR
        =================================*/
      #recordingIndicator {
        display: none;
        margin-top: 14px;
        text-align: center;
        color: #ff5757;
        font-weight: 700;
        letter-spacing: 0.12em;
        animation: pulse 1.4s infinite;
      }

      /* ================================
           TEXT BLOCKS
        =================================*/
      .transcricao-box {
        background: #1c1c1c;
        border: 1px solid #2f2f2f;
        border-radius: 14px;
        padding: 18px;
        min-height: 90px;
        margin-top: 10px;
      }

      /* Caixas de feedback */
      #respostaBox {
        display: flex;
        gap: 18px;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      #respostaText {
        display: flex;
        gap: 16px;
        flex: 1 1 auto;
        flex-wrap: wrap;
      }

      .feedback-container {
        background: #1c1c1c;
        padding: 18px;
        border-radius: 14px;
        border: 1px solid #2d2d2d;
        flex: 1 1 48%;
        min-width: 260px;
        box-sizing: border-box;
        margin-bottom: 12px;
      }

      @media (max-width: 960px) {
        #respostaBox {
          flex-direction: column;
        }
        #respostaText {
          flex-direction: column;
        }
        .feedback-container {
          flex-basis: 100%;
          min-width: auto;
        }
      }

      .log-section {
        background: #1c1c1c;
        padding: 16px;
        border-radius: 14px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid #2a2a2a;
      }

      .log-entry {
        padding: 6px 0;
        border-bottom: 1px solid #333;
        color: #bcbcbc;
      }

      /* Mobile */
      @media (max-width: 960px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <h1>StyleVision</h1>
        <p class="subtitle">Cr√≠ticas de Moda Honestas com IA</p>
      </header>

      <div class="main-grid">
        <div class="card">
          <h2>Seu Look</h2>

          <div class="video-container" id="videoBox">
            <img id="videoFeed" src="/video_feed" alt="C√¢mera desativada" />
            <div id="statusBadge" class="status-badge status-inactive">
              ‚óè Sistema Inativo
            </div>
          </div>

          <div class="captured-preview" id="capturedPreview">
            <h3>üì∏ Look Capturado</h3>
            <img id="capturedImage" src="" />
          </div>
        </div>

        <div class="card">
          <h2>Controles</h2>

          <div class="controls">
            <button
              class="btn btn-primary btn-full-width"
              onclick="ativarSistema()"
            >
              Ativar Sistema
            </button>

            <button
              class="btn btn-success"
              id="btnGravar"
              onclick="iniciarGravacao()"
              disabled
            >
              Fazer Pergunta
            </button>
            <button
              class="btn btn-danger"
              id="btnParar"
              onclick="pararGravacao()"
              disabled
            >
              Parar
            </button>

            <button
              class="btn btn-warning"
              id="btnCapturar"
              onclick="capturarImagem()"
              disabled
            >
              Capturar Look
            </button>
            <button
              class="btn btn-warning"
              id="btnUpload"
              onclick="document.getElementById('fileInput').click()"
              disabled
            >
              Enviar Foto
            </button>

            <input
              type="file"
              accept="image/*"
              id="fileInput"
              style="display: none"
              onchange="uploadImagem(event)"
            />

            <button
              class="btn btn-primary btn-full-width"
              id="btnDescrever"
              onclick="obterDescricao()"
              disabled
            >
              Obter Cr√≠tica
            </button>

            <button
              class="btn btn-danger btn-full-width"
              id="btnDesativar"
              onclick="desativarSistema()"
              disabled
            >
              Desativar Sistema
            </button>
          </div>

          <div id="recordingIndicator">‚óè GRAVANDO...</div>
        </div>
      </div>

      <div class="card">
        <h2>Sua Pergunta e Cr√≠tica</h2>

        <h3>Sua Pergunta:</h3>
        <div class="transcricao-box" id="transcricaoBox">
          <em
            >Pergunte algo como: "Este look combina para um jantar formal?"</em
          >
        </div>

        <div id="respostaBox">
          <div id="respostaText"></div>
          <audio id="audioResposta" controls style="display: none"></audio>
        </div>

        <div class="log-section">
          <strong>Log de Atividades:</strong>
          <div id="logEntries"></div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let mediaRecorder;
      let audioChunks = [];

      function addLog(msg) {
        const log = document.getElementById("logEntries");
        const el = document.createElement("div");
        el.classList.add("log-entry");
        el.textContent = `[${new Date().toLocaleTimeString("pt-BR")}] ${msg}`;
        log.prepend(el);
      }

      function ativarSistema() {
        socket.emit("ativar_sistema");
        addLog("Ativando sistema...");
      }

      function desativarSistema() {
        socket.emit("desativar_sistema");
        addLog("Desativando sistema...");
      }

      async function iniciarGravacao() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: "audio/wav" });
          const reader = new FileReader();
          reader.onloadend = () =>
            socket.emit("processar_audio", { audio: reader.result });
          reader.readAsDataURL(blob);
        };
        mediaRecorder.start();
        document.getElementById("recordingIndicator").style.display = "block";
        document.getElementById("btnGravar").disabled = true;
        document.getElementById("btnParar").disabled = false;
        addLog("Grava√ß√£o iniciada");
      }

      function pararGravacao() {
        if (mediaRecorder) {
          mediaRecorder.stop();
          document.getElementById("recordingIndicator").style.display = "none";
          document.getElementById("btnGravar").disabled = false;
          document.getElementById("btnParar").disabled = true;
          addLog("Grava√ß√£o finalizada");
        }
      }

      function capturarImagem() {
        addLog("Capturando imagem...");
        socket.emit("capturar_imagem");
      }

      function uploadImagem(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("upload_imagem", { image: reader.result });
          addLog("Imagem enviada");
        };
        reader.readAsDataURL(file);
      }

      function obterDescricao() {
        socket.emit("obter_descricao");
        addLog("Solicitando cr√≠tica...");
      }

      /* SOCKET EVENTS */
      socket.on("sistema_status", (data) => {
        const active = data.ativo;
        const statusBadge = document.getElementById("statusBadge");
        const videoBox = document.getElementById("videoBox");

        statusBadge.textContent = active
          ? "‚óè Sistema Ativo"
          : "‚óè Sistema Inativo";
        statusBadge.className = `status-badge ${
          active ? "status-active" : "status-inactive"
        }`;
        videoBox.classList.toggle("active", active);

        document.getElementById("btnGravar").disabled = !active;
        document.getElementById("btnCapturar").disabled = !active;
        document.getElementById("btnUpload").disabled = !active;
        document.getElementById("btnDescrever").disabled = !active;
        document.getElementById("btnDesativar").disabled = !active;

        addLog(data.mensagem);
      });

      socket.on("imagem_capturada", (data) => {
        if (data.success) {
          const img = document.getElementById("capturedImage");
          img.src = data.image_url + "?t=" + Date.now();
          document.getElementById("capturedPreview").style.display = "block";
          addLog(data.mensagem);
        }
      });

      socket.on("imagem_uploaded", (data) => {
        if (data.success) {
          const img = document.getElementById("capturedImage");
          img.src = data.image_url + "?t=" + Date.now();
          document.getElementById("capturedPreview").style.display = "block";
        }
      });

      socket.on("transcricao_completa", (data) => {
        const box = document.getElementById("transcricaoBox");
        box.innerHTML = data.transcricao || "<em>Nenhum √°udio detectado</em>";
        addLog("Transcri√ß√£o recebida");
      });

      socket.on("descricao_completa", (data) => {
        const box = document.getElementById("respostaBox");
        const text = document.getElementById("respostaText");
        const audio = document.getElementById("audioResposta");

        // Limpa conte√∫do anterior
        text.innerHTML = "";
        box.style.display = "block";

        if (data.respostas) {
          if (data.respostas.gemini) {
            const g = document.createElement("div");
            g.className = "feedback-container";
            g.innerHTML = `
              <img src="../assets/geminiicon.png" alt="" style="width: 40px; height: auto; margin-bottom: 8px" />
              <div>${data.respostas.gemini}</div>
            `;
            text.appendChild(g);
          }
          if (data.respostas.gpt) {
            const p = document.createElement("div");
            p.className = "feedback-container";
            p.innerHTML = `
              <img src="../assets/openai.png" alt="" style="width: 40px; height: auto; margin-bottom: 8px" />
              <div>${data.respostas.gpt}</div>
            `;
            text.appendChild(p);
          }
        } else if (data.model) {
          const c = document.createElement("div");
          c.className = "feedback-container";
          const icon = data.model.toLowerCase().includes("gemini")
            ? "../assets/geminiicon.png"
            : "../assets/openai.png";
          c.innerHTML = `
            <img src="${icon}" alt="" style="width: 40px; height: auto; margin-bottom: 8px" />
            <div>${data.resposta || ""}</div>
          `;
          text.appendChild(c);
        } else {
          text.innerHTML = data.resposta || "<em>Nenhuma resposta</em>";
        }

        if (data.audio_urls) {
          audio.style.display = "none";
          if (data.audio_urls.gpt) {
            audio.src = data.audio_urls.gpt + "?t=" + Date.now();
            audio.style.display = "block";
            audio.play();
          } else if (data.audio_urls.gemini) {
            audio.src = data.audio_urls.gemini + "?t=" + Date.now();
            audio.style.display = "block";
            audio.play();
          }
        } else if (data.audio_url) {
          audio.src = data.audio_url + "?t=" + Date.now();
          audio.style.display = "block";
          audio.play();
        }

        addLog("Cr√≠tica recebida");
      });

      socket.on("erro", (data) => {
        alert("Erro: " + data.mensagem);
        addLog("Erro: " + data.mensagem);
      });

      addLog("Interface carregada.");
    </script>
  </body>
</html>